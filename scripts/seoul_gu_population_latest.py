"""
서울시 자치구 단위 인구 요약 생성 스크립트

이 스크립트는 다음 목적을 가진다.
--------------------------------------------------
1. 서울시 인구 통계 원본 CSV를 불러온다
2. 행정동 / 자치구 / 서울시 전체가 섞여 있는 데이터에서
3. 자치구(○○구) 단위만 추린다
4. 여러 연도 중 가장 최근 연도만 선택한다
5. 자치구별 '전체 인구' 요약 CSV를 생성한다
6. 보기좋게 추가로 지도 라벨 / 설명용 문자열 컬럼 추가

이 결과물은:
- QGIS 시군구 shp와 '자치구명' 기준 조인
- 인구 규모 색상 지도
- 중개 상담용 지역 규모 설명 자료로 사용된다.
"""

import pandas as pd
import os

# ==================================================
# 1. 경로 설정
# ==================================================
# - BASE_DIR 기준으로 raw / processed 폴더를 관리
# - 다른 컴퓨터에서도 구조만 같으면 그대로 실행 가능
# ==================================================

BASE_DIR = "/Users/mimi/GitHub/gis-practice"
INPUT_PATH = f"{BASE_DIR}/data/raw/SMG_01_20221107_M_인구통계_text_csv_268.77KB.csv"
OUTPUT_DIR = f"{BASE_DIR}/data/processed"
OUTPUT_PATH = f"{OUTPUT_DIR}/seoul_gu_population_latest.csv"

# 결과 폴더가 없으면 자동 생성
os.makedirs(OUTPUT_DIR, exist_ok=True)

# ==================================================
# 2. 원본 데이터 불러오기
# ==================================================
# - 서울시 공공데이터 CSV
# - UTF-8 계열 인코딩 사용
# ==================================================

df = pd.read_csv(INPUT_PATH, encoding="utf-8")

# ==================================================
# 3. 분석에 필요한 컬럼만 선택
# ==================================================
# YR          : 기준 연도
# ADZN_EMD_NM : 행정구역 이름 (서울특별시 / ○○구 / ○○동 혼재)
# WAN_PUL_CNT : 전체 인구 수
# - 2021,송파구,340992
# ==================================================

df = df[["YR", "ADZN_EMD_CD", "ADZN_EMD_NM", "WAN_PUL_CNT"]]
# ==================================================
# 4. 최신 연도만 선택
# ==================================================
# - 이 데이터에는 여러 연도가 섞여 있음
# - 이번 단계에서는 가장 최근 연도 1개만 사용
# ==================================================

latest_year = df["YR"].max()
df = df[df["YR"] == latest_year]

# ==================================================
# 5. 자치구(○○구) 데이터만 필터링
# ==================================================
# - '서울특별시' / '행정동' 행 제거
# - 이름이 '구'로 끝나는 행만 선택
# ==================================================

df_gu = df[df["ADZN_EMD_NM"].str.endswith("구")]

# ==================================================
# [추가] 자치구 조인용 코드(sgg_cd) 생성
# ==================================================
# - QGIS 시군구(SGG_CD)와 조인하기 위한 핵심 키
# - 문자열(str)로 유지 (앞자리 0 보호)
# ==================================================

# 원본 데이터에 ADZN_EMD_CD가 있는 경우에만 실행
if "ADZN_EMD_CD" in df.columns:
    df_gu["sgg_cd"] = df_gu["ADZN_EMD_CD"].astype(str)



# ==================================================
# 6. 컬럼명 정리 (QGIS 조인용)
# ==================================================

df_gu = df_gu.rename(
    columns={
        "ADZN_EMD_NM": "자치구명",
        "WAN_PUL_CNT": "전체인구"
    }
)

# ==================================================
# 7. 사람 친화 인구 표기 컬럼 생성
# ==================================================
# - 분석용 숫자 컬럼은 유지
# - 지도 라벨 / 설명용 문자열 컬럼 추가
# - "340,992명",약 34.1만 명
# ==================================================

df_gu["전체인구_표시"] = df_gu["전체인구"].map(lambda x: f"{x:,}명")
df_gu["전체인구_만단위"] = df_gu["전체인구"].map(lambda x: f"약 {x/10000:.1f}만 명")

# ==================================================
# 8. 정렬 및 인덱스 정리
# ==================================================

df_gu = df_gu.sort_values("전체인구", ascending=False)
df_gu.reset_index(drop=True, inplace=True)

# ==================================================
# 9. 결과 CSV 저장 (QGIS용)
# ==================================================
# - utf-8-sig : 한글/엑셀/QGIS 호환성 고려
# ==================================================

df_gu.to_csv(OUTPUT_PATH, index=False, encoding="utf-8-sig")

print("완료: seoul_gu_population_latest.csv 생성")
